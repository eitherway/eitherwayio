<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta http-equiv="content-type" content="text/html;charset=utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    

    <title>Build a Raspberry Pi NAS they said. It will be easy... | eitherway</title>
    <link rel="prev" href="https://eitherway.io/posts/epub-malicious-code/" />
    

    <link rel='shortcut icon' type='image/x-icon' href='/img/favicon.ico' />
    <link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
    <link rel="icon" type="image/svg+xml" href="/img/favicon.svg">
    <link rel="icon" type="image/png" sizes="32x32" href="/img/favicon_32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/img/favicon_16x16.png">

    <link rel="stylesheet" href="https://eitherway.io/style/style.css">

    
    
    
    
    

    <script async defer data-skip-dnt="true" src="https://a.eitherway.io/app.js"></script>
    <noscript><img src="https://a.eitherway.io/image.gif" alt=""></noscript>

    <link rel="canonical" href="https://eitherway.io/posts/raspberry-pi-nas/" />
    
        <meta name="twitter:card" content="summary_large_image" />
    
    
    <meta name="twitter:site" content="@eitherwayio" />
    <meta name="twitter:creator" content="@eitherwayio" />
    

    <meta property="og:locale" content="en_US">
    <meta property="og:url" content="https://eitherway.io/posts/raspberry-pi-nas/">
    <meta property="og:site_name" content="eitherway">
    <meta property="og:title" content="Build a Raspberry Pi NAS they said. It will be easy... | eitherway">

    
        <meta property="og:image" content="https://eitherway.io/img/bitbert-square.png">

    <meta name="description" content="">
    <meta property="og:description" content="">
    <script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BlogPosting",
  "headline": "Build a Raspberry Pi NAS they said. It will be easy... | eitherway",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https:\/\/eitherway.io\/posts\/raspberry-pi-nas\/"
  },
  
  "genre": "posts",
  
  "wordcount":  651 ,
  "url": "https:\/\/eitherway.io\/posts\/raspberry-pi-nas\/",
  "datePublished": "2021-05-15T13:18:56\u002b02:00",
  "dateModified": "2021-05-15T13:18:56\u002b02:00",
  "license": "All rights reserved.",
  
  "author": {
    "@type": "Person",
    "name": "Ramon"
  },
  "description": ""
}
</script>
</head>
<body class="o-base-wrapper">
<svg class="o-base-wrapper__monsta" clip-rule="evenodd" fill-rule="evenodd" stroke-linejoin="round"
     stroke-miterlimit="2" viewBox="0 0 1500 1500"
     xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    <clipPath id="a">
        <ellipse clip-rule="evenodd" cx="545.529" cy="987.512" rx="85.675" ry="77.138"/>
    </clipPath>
    <g transform="matrix(-1.865072 0 0 -1.865072 2318.2612 2347.752)">
        <path d="m355.811 181.655c16.996-13.614 20.999 38.213 19.346 119.32-1.754 86.043 42.845 267.3 42.845 267.3l-162.7 43.605s1.127-157.515 17.879-229.219c16.48-70.543 65.634-187.391 82.63-201.006z"
              fill="#71072d" transform="matrix(.583322 .210024 -.268501 .745737 671.32 399.406)"/>
        <path d="m355.811 181.655c16.996-13.614 20.999 38.213 19.346 119.32-1.754 86.043 42.845 267.3 42.845 267.3l-162.7 43.605s1.127-157.515 17.879-229.219c16.48-70.543 65.634-187.391 82.63-201.006z"
              fill="#71072d" transform="matrix(.583322 .210024 -.268501 .745737 411.974 346.231)"/>
        <g fill="#bc0b4b">
            <path d="m1306.72 286.009c22.9 10.338-757.474 118.493-759.127 199.6-.593 29.117-42.746 126.784-42.746 126.784l-186.731-116.515s45.684-40.683 166.89-68.531c147.008-33.777 798.814-151.676 821.714-141.338z"
                  transform="matrix(.555562 .200029 -.55818 1.55029 496.663 -143.648)"/>
            <path d="m422.737 130.705c16.996-13.614-45.927 89.163-47.58 170.27-1.754 86.043 65.75 408.595 65.75 408.595l-281.919-.393s70.235-230.104 114.193-326.516c40.518-88.865 132.56-238.342 149.556-251.956z"
                  transform="matrix(.583322 .210024 -.268501 .745737 827.504 346.231)"/>
            <path d="m490.655 270.539c15.256 5.495-114.175 13.915-115.828 95.022-1.753 86.042 43.175 202.714 43.175 202.714l-162.7 43.605s-11.238-222.399 27.988-279.289c39.225-56.89 192.108-67.546 207.365-62.052z"
                  transform="matrix(.538827 .306659 -.560043 .984043 1041.02 215.935)"/>
        </g>
        <g fill="#e20e5a">
            <path d="m422.737 130.705c16.996-13.614-45.927 89.163-47.58 170.27-1.754 86.043 65.75 408.595 65.75 408.595l-281.919-.393s70.235-230.104 114.193-326.516c40.518-88.865 132.56-238.342 149.556-251.956z"
                  transform="matrix(.583322 .210024 -.268501 .745737 576.805 284.972)"/>
            <path d="m421.001 171.187c5.966 14.059-59.644 76.155-61.297 157.262-1.753 86.043 58.298 239.826 58.298 239.826l-162.7 43.605s-26.395-167.022 1.222-240.471c13.122-34.901 33.565-88.589 67.385-127.319 37.354-42.777 91.126-86.963 97.092-72.903z"
                  transform="matrix(.583322 .210024 -.268501 .745737 495.89 296.591)"/>
            <path d="m357.947 174.796c18.429-12.185 3.272 39.792 1.619 120.899-1.754 86.043 58.436 272.58 58.436 272.58l-162.7 43.605s-23.418-170.232-6.311-243.079c16.957-72.205 90.527-181.821 108.956-194.005z"
                  transform="matrix(.583322 .210024 -.320915 .891311 777.269 307.731)"/>
            <path d="m465.818 236.49c14.982 2.064-76.992 50.132-78.645 131.239-1.753 86.043 30.829 200.546 30.829 200.546l-162.7 43.605s6.895-193.97 41.981-256.535c33.625-59.959 153.554-120.919 168.535-118.855z"
                  transform="matrix(.538827 .306659 -.560043 .984043 1010.98 191.406)"/>
            <path d="m465.818 236.49c14.982 2.064-76.992 50.132-78.645 131.239-1.753 86.043 30.829 200.546 30.829 200.546l-162.7 43.605s6.895-193.97 41.981-256.535c33.625-59.959 153.554-120.919 168.535-118.855z"
                  transform="matrix(.619127 .0325004 -.0593546 1.13069 281.992 264.809)"/>
            <path d="m568.148 218.87c-17.694 13.006-149.939 38.024-200.282 114.901-46.147 70.471-7.261 148.804-7.855 177.957-1.754 86.042 80.896 197.842 80.896 197.842l-281.919-.393s26.983-237.097 83.207-330.714c44.849-74.676 72-92.483 123.698-117.067 98.192-46.693 213.179-50.556 202.255-42.526z"
                  transform="matrix(.583322 .210024 -.330258 .91726 712.222 215.401)"/>
            <path d="m1042.32 688.741c105.73-81.025 164.28-19.694 164.28-19.694s-85.6-.991-97.4 53.669c-31.15 144.329-5.22 826.284-5.22 826.284h-707.955s-18.961-849.702 0-860.259c156.682-87.238 646.295 0 646.295 0z"/>
        </g>
        <g transform="matrix(2.18542 -.482704 .536121 2.42727 -989.769 -1162.68)">
            <ellipse cx="545.529" cy="987.512" fill="#fff" rx="85.675" ry="77.138"/>
            <g clip-path="url(#a)">
                <g id="pupil" transform="translate(30,-30)">
                    <circle fill="#1a1a1a" r="97.152"
                            transform="matrix(.81323306 .34004017 -.37766983 .73220505 545.528991 987.512565)"/>
                    <ellipse cx="592.294" cy="960.502" fill="#fff" rx="38.075" ry="28.247"
                             transform="matrix(.70113572 .29316819 -.43891001 .85093433 551.825191 -3.4539)"/>
                </g>
                <g id="pupil-reference" style="opacity: 0">
                    <circle fill="#1a1a1a" r="97.152"
                            transform="matrix(.81323306 .34004017 -.37766983 .73220505 545.528991 987.512565)"/>
                    <ellipse cx="592.294" cy="960.502" fill="#fff" rx="38.075" ry="28.247"
                             transform="matrix(.70113572 .29316819 -.43891001 .85093433 551.825191 -3.4539)"/>
                </g>
            </g>
        </g>
    </g>
</svg>

    <div class="o-back-home">
        <a href="https://eitherway.io/" aria-label="Back to Homepage" class="o-more-decent-link o-back-home__link">
            <svg xmlns="http://www.w3.org/2000/svg" class="o-back-home__caret icon icon-tabler icon-tabler-chevron-left"
                 viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="square"
                 stroke-linejoin="miter">
                <path stroke="none" d="M0 0h24v24H0z"/>
                <polyline points="15 6 9 12 15 18"/>
            </svg>
        </a>
    </div>

<div class="o-article-wrapper o-base-wrapper__content">
    














<div class="o-h1">
    
    
    
    
    
    <h1 class="o-h1__h1">

Build a Raspberry Pi <span class="o-h1__colored">NAS</span> they said. It will be <span class="o-h1__colored">easy</span>...

</h1>
    <p class="o-h1__under">* Nobody said that, I had the idea myself.</p>
</div>
<p class="o-text">First off, what were the goals? The NAS should be:</p>
<ul class="o-list">
<li class="o-list__item">redundant and protect from a drive failure.</li>
<li class="o-list__item">cheap.</li>
<li class="o-list__item">an easy to use solution for my onsite backup.</li>
<li class="o-list__item">powered by a single USB-C Cable.</li>
</ul>
<h2 class="o-h2" id="just-connect-two-ssds-via-usb-to-a-raspberry-pi-4-and-run-the-nas-what-could-go-wrong">Just connect two SSDs via USB to a Raspberry Pi 4 and run the NAS. What could go wrong?</h2>
<p class="o-text">Yeah, no:</p>
<p class="o-text"><figure class="o-img">
    <img class="o-img__img" src="/img/posts/pi-nas/pi-mess.jpg" alt="Raspberry Pi Mess - two power cables for one Pi"  />
</figure></p>
<h3 class="o-h3" id="why-not-power-it-through-an-external-usb-hub">Why not power it through an external USB-Hub?</h3>
<p class="o-text">Yeah, look at the picture above: <em>That is ugly.</em></p>
<h3 class="o-h3" id="why-ssds-ssds-are-not-cheap">Why SSDs? SSDs are not cheap.</h3>
<p class="o-text">SSDs have two main advantages. First off they are fast and more importantly they don&rsquo;t consume much power.</p>
<p class="o-text">The Raspberry Pi 4 has a <a class="o-link" href="https://www.raspberrypi.org/documentation/hardware/raspberrypi/power/README.md">power limit of 1.2 A on the USB Ports</a>. So a two traditional hard drive would drain too much power and the Pi won&rsquo;t boot. SSDs don&rsquo;t consume so much power and so the Pi 4 should &ldquo;theoretical&rdquo; have no problem.</p>
<p class="o-text">Turns out two SSDs drain still too much power.</p>
<p class="o-text">In the process of fixing this problem I&rsquo;ve tried finding SSDs which draw less power.</p>
<p class="o-text">Models I&rsquo;ve tested:</p>
<ul class="o-list">
<li class="o-list__item">SanDisk Ultra 3D SSD</li>
<li class="o-list__item">Kingston A400</li>
<li class="o-list__item">Samsung 870 Evo</li>
<li class="o-list__item">Crucial MX500</li>
</ul>
<p class="o-text">I&rsquo;ve had problems with all of them, sometimes the SSD randomly disconnected and sometimes I&rsquo;ve got very slow IO.</p>
<h2 class="o-h2" id="the-solution-to-the-power-problem">The solution to the Power problem</h2>
<p class="o-text">After googling a bit, I&rsquo;ve found a <a class="o-link" href="https://raspberrypi.stackexchange.com/questions/104038/can-the-pi-4-power-2-external-usb-3-hdds">a little hacky but wonderful solution to this problem</a>:</p>
<p class="o-text">Just solder the 5V GPIO Pin with the Ubat PIN of the USB socket, and it will be fine.</p>
<p class="o-text"><figure class="o-img">
    <img class="o-img__img" src="/img/posts/pi-nas/pi-back.jpg" alt="Raspberry Pi - Ubat PIN soldered to USB socket"  />
</figure></p>
<p class="o-text">The last time I soldered was 8 years ago. So I did it like every good global corporation: I outsourced the problem.</p>
<p class="o-text">Another tip of the googled solution was that you should connect a small capacitor to the 5V PIN and the GND Pin. Thank you again, <a class="o-link" href="https://raspberrypi.stackexchange.com/users/33476/dmitry-grigoryev">Dmitry Grigoryev</a>!
<figure class="o-img">
    <img class="o-img__img" src="/img/posts/pi-nas/pi-capacitor.jpg" alt="Capacitor connected to GND and 5V PIN"  />
</figure></p>
<p class="o-text">If you don&rsquo;t have a Capacitor at home, become friends with an electrician and ask them for one. That&rsquo;s what I did.</p>
<p class="o-text">I got a 16V 470ÂµF Capacitor. It works perfectly.</p>
<h2 class="o-h2" id="the-solution-to-the-nas-problem">The solution to the NAS Problem</h2>
<p class="o-text"><strong class="o-bold">ZFS</strong>. It&rsquo;s the solution, and it&rsquo;s amazing.</p>
<p class="o-text">As I had a lot of drive failures and SSD disconnects, I could enjoy the recovery mechanisms of ZFS multiple times.</p>
<p class="o-text">No matter if the Raspberry Pi failed or one of the SSDs, it&rsquo;s relatively easy to recover from a failed state. You can wipe the Raspberry Pi&rsquo;s MicroSD and one SSD and you can still recover from that state with ZFS.</p>
<p class="o-text"><strong class="o-bold">Trust me</strong>, I tested all of this (more or less voluntarily).</p>
<h3 class="o-h3" id="quick-zfs-setup">Quick ZFS Setup</h3>
<p class="o-text">I will not go into details. Please read another tutorial for this.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">zpool create -f -o <span class="nv">autoexpand</span><span class="o">=</span>on -o <span class="nv">ashift</span><span class="o">=</span><span class="m">13</span> tank mirror /dev/sda /dev/sdb
</span></span></code></pre></div><p class="o-text">This willl create a ZFS pool called <code>tank</code> from two external disks (<code>/dev/sda</code>and <code>/dev/sdb</code>).</p>
<p class="o-text"><strong class="o-bold">The important thing of this command is the <code>ashift</code> value:</strong> This is the sector size which ZFS will use, it&rsquo;s recommend to set it to the physical block size of your SSD.</p>
<p class="o-text">It can&rsquo;t be changed later on. If you set it too low, you will run into major performance issues.</p>
<br>
<br>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">zfs create -o <span class="nv">compression</span><span class="o">=</span>lz4 -o <span class="nv">quota</span><span class="o">=</span>600G tank/backup
</span></span></code></pre></div><p class="o-text">The important thing about this is the compression, which you should enable. The compression saves you space and leads to a better read/write performance. Whereas the performance penalty for your Raspberry is relatively low.</p>
<h3 class="o-h3" id="useful-zfs-commands">Useful ZFS Commands</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">zpool import -a
</span></span></code></pre></div><p class="o-text">On my first reboot after ZFS Setup, I&rsquo;ve run in the problem where the Pool was not automatically imported. Removing the <code>/tank</code> dir and importing it again has done the trick.</p>
<br>
<br>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">parted -l
</span></span></code></pre></div><p class="o-text">Excellent Command to see all connected and mounted drives.</p>
<br>
<br>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">zpool status -sv
</span></span></code></pre></div><p class="o-text">This will give you a verbose status of your ZPool. Useful if you want to see if you have any Errors or if one of your SSD is too slow (<code>-s</code>).</p>
<br>
<br>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">zpool events
</span></span></code></pre></div><p class="o-text">More detailed error or event messages of your ZPool.</p>
<br>

<div id="rating" class="o-rating">
    <div class="o-inline-box"><span class="o-inline-box__important">Wait! Before you go</span>
        <span class="o-inline-box__normal"> and do important stuff:<br>Would you mind give me a little feedback? It would really help me to improve my articles.</span>
    </div>
    <p class="o-rating__question">What rating would you give this article?</p>
</div>

    <div class="o-back-home-link"><a href="https://eitherway.io/" aria-label="Back to Homepage" class="o-back-home-link__link o-more-decent-link o-more-decent-link--home">
            <div class="o-back-home--wr">
                <svg xmlns="http://www.w3.org/2000/svg" class="o-back-home-link__icon icon-tabler icon-tabler-chevron-left"
                     viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="square"
                     stroke-linejoin="miter">
                    <path stroke="none" d="M0 0h24v24H0z"/>
                    <polyline points="15 6 9 12 15 18"/>
                </svg>
                Back to Homepage
            </div>
        </a>
    </div>

<script src="https://scripts.likeknob.com/script.min.js"></script>
<script>
    var rating1 = document.getElementById('rating')

    var options = {
        cssReset: false,
        question: "What did you not like about this article?",
        ratingBarContainerClass: "o-rating__bar", 
        questionContainerClass: "o-rating__question-container",
        questionClass: "o-rating__question",
        inputClass: "o-rating__input",
        buttonContainerClass: 'o-rating__button-container',
        sendButtonClass: "o-rating__button",
        inputStyle: "",
        sendButtonStyle: "",
        questionStyle: "",
        questionContainerStyle: "",
    }

    likeKnob(rating1, "3676328c-d7ef-4f56-a6dc-ec8e35563c10", options)
</script>

</div>
<div class="o-footer o-base-wrapper__footer">
    <ul class="o-footer_list">
        
            <li class="o-footer_elem"><a class="o-footer_link" href="/imprint">Imprint</a></li>
        
            <li class="o-footer_elem"><a class="o-footer_link" href="/privacy">Privacy Policy</a></li>
        
    </ul>
</div>
<script>
    
    console.log("Hey! Looking at my code?");
    
    console.log("Found Issues?");
    
    console.log("Interested or want to talk?");
    
    console.log("Mail me at ramon@eitherway.io");
    
    console.log("For PGP Encryption: https:\/\/eitherway.io\/pgp-key.asc");
    
</script>

<script src="https://eitherway.io/js/monsta.min.19763c7162909585cbbad04b2f3a34160b3ba06051cd6bc1711379d34edd1df7.js" integrity="sha256-GXY8cWKQlYXLutBLLzo0Fgs7oGBRzWvBcRN5007dHfc="></script>
</body>
</html>